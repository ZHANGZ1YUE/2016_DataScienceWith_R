---
title: "Air quality analysis and the correlation of car  accident"
author: "Frank Zhang & Clint Fu"
date: "October 30, 2016"
output: 
  ioslides_presentation:
    smaller: no
    widescreen: yes
    width: 1920
    height: 1080 
    keep_md: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, cache = T, warning = F, message = F, cache.lazy = FALSE)
```

## Motivation
Air quality has been a really hot topic recently. This project aimed on analyzing the correlation between two most familiar harzard gases --- SO2 and Ozone. Since the source of both of the gases consists of the waste emission of mobiles; we expect to understand the correlation between the concentration of this two kind of gases so that we could learn if they come from the same compound in the car waste or not. 
On the other hand, we want to anaylze the correlation between the correlation of SO2 with the number of car accident; we want to learn if the hazard gases could contribute to the performance of driver and therefore cauce accidents.

## Data description
Air quality data collected at outdoor monitors across the United States, Puerto Rico, and the U.S. Virgin Islands. The data comes primarily from the AOS data base. (Among which we chose the data of Ozone and SO2.) The data and is downloaded in
[Air_Quality](https://aqsdr1.epa.gov/aqsweb/aqstmp/airdata/download_files.html#Raw) and
[Car_Accident](http://accidentdatacenter.com/us/new-jersey/trenton-nj/atlantic-city).
The picture can be found in this 
[picture_link](https://handlemanpost.wordpress.com/2015/06/13/great-plains-wind-not-disruptive-to-residents/)


## Library used
```{r library, echo = T, results = "hide"}
packs <- c("png","ggplot2","dplyr","readr","lubridate","ggmap",
           "plotly","shiny", "stringr","readxl","grid", "gridExtra")
lapply(packs, library, character.only = TRUE)

```

# Load data

Create small subset for debuging

```{r, eval=F}
set.seed(123)
df<- sample_n(full_df, 10000)
write_excel_csv(df, path = "df.csv")
df2<- sample_n(full_df2, 10000)
write_excel_csv(df2, path = "df2.csv")
dfn<- sample_n(full_dfn, 10000)
write_excel_csv(dfn, path = "dfn.csv")
```

Load data

```{r, eval = T}
load_full_data = F

if(load_full_data == T){
  df <- read_csv("Ozone.csv")
  dim(df)
  df2<- read_csv("SO2.csv")
  dim(df2)
  dfn<- read.csv("accident.csv")
  dim(dfn)
}else{
  df <- read_csv("df.csv")
  dim(df)
  df2<- read_csv("df2.csv")
  dim(df2)
  dfn<- read.csv("dfn.csv")
  dim(dfn)
}

```

```{r delete}
df2<- df2%>%
  mutate(Method_Name = 
           str_replace(`Method Name`,"INSTRUMENTAL - ", "")) %>%
  mutate(Method_Name = 
           str_replace(Method_Name,"Instrumental - ", ""))

df<- df%>%
  mutate(Method_Name = 
           str_replace(`Method Name`,"INSTRUMENTAL - ", "")) %>%
  mutate(Method_Name = 
           str_replace(Method_Name,"Instrumental - ", ""))

```


# Understand the Data
```{r Number of Method}
#Overlook of Method used
df%>%
  group_by(Method_Name)%>%
  summarise(n())
```

```{r Study of Method vs. Sample Measurement}
#See if there is difference between the data generated using different Method.
df%>%
  group_by(`Method Name`)%>%
  summarise(mean_measure = mean(`Sample Measurement`))

ggplot(df)+
  geom_boxplot(aes(x = Method_Name, y =  `Sample Measurement`))+
  ggtitle("Ozone concentration measured by different methods")+
  theme(axis.text.x = element_text(angle = 22, hjust = 1))+
  theme(text = element_text(size=10)) +
  xlab("Name of the method used to measure Ozone level") +
  ylab("Ozone concentration, ppm")

```

The data of sample measurement collected by different Method shows little difference. 

# Data analysis
```{r Time in Second to Time in Hour}
Ozone <- df%>%
  mutate(Time_in_Hour = `Time Local`/3600)
SO2 <- df2%>%
  mutate(Time_in_Hour1 = `Time Local`/3600)
```

## Time vs. Sample Measurement
```{r Ozone}
ggplot(Ozone)+
  geom_boxplot(mapping = aes(x=factor(Time_in_Hour), y=`Sample Measurement`)) +
  ggtitle("Measure of Ozone with time for each Method") +
  xlab("Time in Hour") +
  ylab("Ozone concentration") 
ggplotly()
```

```{r SO2}
ggplot(SO2)+
  geom_boxplot(mapping = aes(x=factor(Time_in_Hour1), y=`Sample Measurement`)) +
  ggtitle("Measure of SO2 with time for each Method") +
  xlab("Time in Hour") +
  ylab("SO2 concentration")
ggplotly()
```

The plot showed that the amount of Ozone are generally richer at afternoon(10-17)

## Geographical Distribution of the hazard gases
```{r Map the Ozone, warning = FALSE, cache = T}
map <- get_map("the United States of America", zoom = 4, maptype = 'hybrid',
                      source = 'google', color='color')

Df_New <- 
  df%>%
  group_by(`State Name`) %>%
  mutate(mean_measure = mean(`Sample Measurement`)) %>%
  select(mean_measure, `State Name`, Longitude, Latitude) %>%
  unique()

plota <- ggmap(map) + 
  geom_point(data = Df_New, aes(x = Longitude, y = Latitude, colour = mean_measure), size = 3, alpha = 0.5) +
  ggtitle("Geographic distribution for Ozone Concentration") +
  xlab("Longitude") +
  ylab("Latitude")

Df2_New <- 
  df2 %>%
  group_by(`State Name`) %>%
  mutate(mean_measure = mean(`Sample Measurement`)) %>%
  select(mean_measure, `State Name`, Longitude, Latitude) %>%
  unique()

plotb <- ggmap(map) + 
  geom_point(data = Df2_New, aes(x = Longitude, y = Latitude, colour = mean_measure), size = 3, alpha = 0.5) +
  ggtitle("Geographic distribution for SO2 Concentration") +
  xlab("Longitude") +
  ylab("Latitude")

img <- readPNG("./111.png")
g <- rasterGrob(img, interpolate=TRUE) 

plotc <- 
  ggplot()+
  theme_bw() +
  annotation_custom(g, xmin=-Inf, xmax=Inf, ymin=-Inf, ymax=Inf) +
  ggtitle("Population density of the United States")

plota
plotb
plotc
```


Map shows that the Ozone are rich in the east and west coast of the United States usually contains higher amount of Ozone. And it is clear that the places covered with vegetation has more concentrated and wider covarage of Ozone. Especially around the lake area and coastal area.
Map also shows that concentrated SO2 are distributed in the Northeast part and south west part of the United States. 


## SO2 vs. Ozone
```{r Merge, eval=T}
OzoneAmount <- df %>% select(`Sample Measurement`, `Date Local`) %>% rename("MeasureOzone" = `Sample Measurement`)

SO2Amount <- df2 %>% select(`Sample Measurement`, `Date Local`)%>% rename("MeasureSO2" = `Sample Measurement`)
df3 <- OzoneAmount%>% left_join(SO2Amount)
df3<- unique(df3)%>%
  sample_n(10000)
```

```{r Study how the existence of SO2 influnces the amount of the Ozone, eval = T}
ggplot(df3)+
  geom_point(mapping = aes(x = MeasureOzone,y = MeasureSO2))+
  ggtitle("Measure of Ozone with Measure of SO2 (Same Date)") +
  xlab("Ozone concentration")+
  ylab("SO2 concentration")
```

From this plot we can see that the measure of Ozeon and SO2 are completely random distributed, which means that there is no correlation nor causation between these variables.

## Join With the car accident data in Atlantic city
```{r join and tidy}
dfnn<- dfn%>%
  rename("Latitude" = LATITUDE, "Longitude" = LONGITUDE)

Countless <- dfnn %>%
  mutate(Date = mdy(ACC_DATE))%>%
  select(ACC_DATE, Date)

dfd<- df%>%
  mutate(Date = ymd(`Date Local`))

CountTb <- Countless %>%
  group_by(ACC_DATE)%>%
  mutate(number = n()) %>%
  ungroup()

join<- dfd%>%
full_join(CountTb)

set.seed(324)
joinfinal<- sample_n(join, 50000)
```

```{r correlation}
plot1 <- joinfinal%>%
  ggplot()+
    geom_point(mapping = aes(x = `Sample Measurement`, y = number), alpha = 0.01) +
    geom_smooth(method = lm, mapping = aes(x = `Sample Measurement`, y = number)) +
    ggtitle("Car accidents measure \n with Ozone measure") +
    xlab("Ozone concentration") +
    ylab("number of measurement")

plot2 <- joinfinal%>%
  ggplot()+
    geom_smooth(method = lm, mapping = aes(x = `Sample Measurement`, y = number)) +
    xlab("SO2 concentration") +
    ylab("number of measurement") 


grid.arrange(plot1, plot2, ncol=2)

```


## Conclusion
In this report, several relationships between measurement of Ozone, SO2, Method Type, Method Name, Date, Time and car accidents are discussed with plots.
The distribution of Ozone showed consistance with the population distribution --- when there are dense population, it tends to high concentration of Ozone. However, the SO2 concentration shows relative low dependence on the population distribution. 